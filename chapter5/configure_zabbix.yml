- name: Configure Zabbix Server
  hosts: zabbix
  vars:
    ansible_become: yes
    ansible_become_method: sudo
    ansible_become_password: vagrant
    DBName: zabbix
    DBUser: zabbix
    DBPassword: password

  tasks:

    - name: Disable SELinux
      selinux:
        state: disabled
      notify: Restart to Apply Configuration

    - name: Enable Zabbix repo
      yum:
        name: http://repo.zabbix.com/zabbix/4.2/rhel/7/x86_64/zabbix-release-4.2-2.el7.noarch.rpm
        state: present

    - name: Install Zabbix Packages
      yum:
        name: 
          - epel-release
          - zabbix-server-mysql
          - zabbix-web-mysql
          - zabbix-web-japanese
          - zabbix-agent
          - MySQL-python 

    - name: Install MariaDB
      yum:
        name:
          - mariadb-server
    
    - name: Start and Enable MariaDB Service
      systemd:
        name: mariadb
        state: started
        enabled: yes

    - name: Create Database
      mysql_db:
        name: "{{ DBName }}"
        state: present
        encoding: utf8
        collation: utf8_bin

    - name: Create DB_User with GRANT Option
      mysql_user:
        name: "{{ DBUser }}"
        state: present
        password: "{{ DBPassword }}"
        priv: 'zabbix.*:ALL,GRANT'

    - name: Check Table Count before Import Zabbix Schema File
      shell: mysql -u root -ss {{ DBName }} -e "show tables;" | wc -l
      register: check_tables
    - debug: msg="{{ check_tables }}"
    - name: Configure Zabbix DB
      shell: zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql {{ DBName }} -u root
      when: check_tables.stdout == "0"

    - name: Configure zabbix_server.conf
      template:
        src: templates/zabbix_server.conf.j2
        dest: /etc/zabbix/zabbix_server.conf
        owner: root
        group: zabbix

    - name: Configure httpd conf for Zabbix
      template:
        src: templates/httpd_zabbix.conf.j2
        dest: /etc/httpd/conf.d/zabbix.conf

    - name: Check Current localse Setting
      shell: localectl status
      changed_when: false
      register: locale_result

    - name: Set locale for Japanese Language setting on Zabbix
      shell: localectl set-locale LANG=ja_JP.utf8
      when: "'LANG=ja_JP.utf8' not in locale_result.stdout"

    - name: Restart Zabbix Related Services
      systemd:
        name: "{{ item }}"
        state: restarted
        enabled: yes
      with_items:
        - zabbix-server
        - zabbix-agent
        - httpd

  handlers:
    - name: Restart to Apply Configuration
      reboot:
        reboot_timeout: 3600
